<html>
<head>
	<script src='jquery.js'></script>
	<script src='styles.js'></script>
	<script>
		var size = 20, width = 30, height = 20;
		var data = null, format = "nothing";
		function init(adata, aformat) {
			data = adata;
			format = aformat;
		}
		
		var r = {};
		var postRender = function() {}
		
		function add(portion) {
			data.push(portion);
		}
		
		$(function() {
			var ctx = $("#canvas")[0].getContext("2d");
			ctx.font = "10px verdana ";
			function render(cells) {
				ctx.clearRect(0, 0, size*width, size*height);
				for (var c = 0; c < cells.length; c++) {
					for (var r = 0; r < cells[c].length; r++) {
						var x = size*c, y = size*r;
						var cell = cells[c][r];
						var styles = (cell.class || "").split(' ').map(function(n) { return Styles[n] || {};});
						var style = {fillStyle: "white", strokeStyle: "white", textStyle: 'black'};
						styles.forEach(function(s) { style = $.extend(style, s);});
						ctx.fillStyle = style.fillStyle;
						ctx.strokeStyle = style.strokeStyle;
						ctx.fillRect(x, y, size, size);
						ctx.strokeRect(x, y, size, size);
						if (cell.text) {
							ctx.strokeStyle = style.textStyle;
							ctx.strokeText(cell.text, x+2, y+size-2);
						}
						if (style.indicator1Style)
						{
							ctx.fillStyle = style.indicator1Style;
							ctx.fillRect(x+2,y+2,2,2);
						}
						if (style.indicator2Style)
						{
							ctx.fillStyle = style.indicator2Style;
							ctx.fillRect(x+5,y+2,2,2);
						}
					}
				}
			}
			
			r.nothing = function render_nothing() {
				render(["nothing".split('').map(function(c) { return {text: c}})]);
			}
			
			r.grid = function render_grid() {
				render(data);
			}
			
			r.steps = function render_steps() {
				data.forEach(function(step, idx) {
					$("#step").append("<option data-step='" + idx + "'>" + step.name + "</option>");
				});
				$("#step2").hide();
				$("#step").change(function() {
					var stepdix = $("#step").find("option:selected").attr("data-step");
					render(data[stepdix].data);
					postRender(data[stepdix].data, data[stepdix]);
					$("#log").html(data[stepdix].log.join("\n\n"));
				});
				$("#step option").eq(0).click();
				$("#step").change();
			}
			
			r.visibility = function render_visibility() {
				var plainMap = data.map;
				var visibility = data.visibility;
				var height = plainMap[0].length, width = plainMap.length;
				function apply(x, y, fromStance, toStance) {
					var stance = Math.min(fromStance, toStance);
					for (var c = 0; c < plainMap.length; c++) {
						for (var r = 0; r < plainMap[c].length; r++) {
							var visibleFrom = visibility[x * height * width  * height * 3 + y * width * height * 3 + c * height * 3 + r * 3 + stance];
							var visibleTo = visibility[c * height * width  * height * 3 + r * width * height * 3 + x * height * 3 + y * 3 + stance];
							if (plainMap[c][r].class.indexOf("free") == 0) {
								var classes = ["free"];
								if (visibleFrom) classes.push("visible");
								if (visibleTo) classes.push("visibleBack");
								plainMap[c][r].class = classes.join(" ");
							}
						}
					}
					render(plainMap);
					$("#log").html("x = " + x + ", y = " + y);
				}
				["prone", "kneeling", "standing"].forEach(function(name, idx) {
					$("#step").append("<option data-stance='" + idx + "'>" + name + "</option>");
					$("#step2").append("<option data-stance='" + idx + "'>" + name + "</option>");
				});
				var x = -1, y = -1;
				function onChange(newX, newY) {
					if (newX != undefined) {
						x = newX;
						y = newY;
					}
					var stance1 = $("#step option:selected").attr("data-stance") |0;
					var stance2 = $("#step2 option:selected").attr("data-stance") |0;
					if (x != -1) apply(x, y, stance1, stance2);
				}
				$("#step").change(function() {onChange();});
				$("#step2").change(function() {onChange();});
				$("#canvas").mousemove(function(e) {
					var x = Math.floor((e.clientX - $("#canvas").offset().left) / size);
					var y = Math.floor((e.clientY - $("#canvas").offset().top) / size);
					onChange(x, y);
				});
				
			}
			
			format = format || "grid";
			
			r[format]();
			
		});
		
	</script>
	<style>canvas, pre {float: left; margin: 10px; border: 1px solid #ccc;}
	pre {background: #eee; padding: 5px;}</style>
</head>
<body>
	<select id="step"></select> <select id="step2"></select>
	<br/>
	<canvas id="canvas" width="600" height="400"></canvas>
	<pre id="log"></pre>
</body>
</html>